flowchart TD
    %% Styling Definitions
    classDef actor fill:#f9f,stroke:#333,stroke-width:2px;
    classDef container fill:#e1f5fe,stroke:#0277bd,stroke-width:2px;
    classDef component fill:#ffffff,stroke:#0277bd,stroke-dasharray: 5 5;
    classDef database fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
    classDef external fill:#fff3e0,stroke:#ef6c00,stroke-width:2px;
    classDef security fill:#ffebee,stroke:#c62828,stroke-width:2px;
    classDef obs fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px;

    %% Actors
    User((User)):::actor

    %% System Boundary: Docker Environment
    subgraph Docker_Compose [Docker Environment]
        style Docker_Compose fill:#fafafa,stroke:#666,stroke-width:2px,stroke-dasharray: 5 5

        %% UI Container
        subgraph UI_Container [Streamlit Container]
            direction TB
            StreamlitApp[Streamlit UI<br/>src/ui/streamlit_app.py]:::container
        end

        %% API Container
        subgraph API_Container [API Container]
            direction TB
            FastAPI[FastAPI Server<br/>src/api/main.py]:::container
            
            subgraph Security [Security Layer]
                AuthService[Auth Service<br/>JWT / RBAC]:::security
            end

            %% Core Logic Components
            subgraph Core_Logic [Orchestration Layer]
                Orchestrator[Query Orchestrator<br/>src/orchestration]:::component
                SelfCorrection[Self-Correction Loop]:::component
            end

            %% Factory Patterns
            subgraph Factories [Integration Layer]
                LLMFactory[LLM Factory]:::component
                ConnFactory[Connector Factory]:::component
            end

            %% Performance & Persistence
            subgraph Cache_Storage [Caching Layer]
                Redis[(Redis Cache)]:::database
            end
            
            %% RAG Components
            subgraph RAG_System [RAG Engine]
                Embeddings[Embedding Service]:::component
                VectorDB[(ChromaDB)]:::database
            end
        end

        %% Observability Subsystem
        subgraph Monitoring [Observability]
            Prom[Prometheus]:::obs
            Grafana[Grafana]:::obs
        end
    end

    %% External Systems
    subgraph External_Cloud [External Services]
        direction LR
        OpenAI[OpenAI API]:::external
        Gemini[Google Gemini API]:::external
    end

    subgraph Data_Sources [Data Layer]
        direction LR
        PG[(PostgreSQL)]:::database
        MySQL[(MySQL)]:::database
        SQLite[(SQLite)]:::database
        BQ[(BigQuery)]:::database
    end

    %% Relationships / Data Flow
    User -->|1. Credentials / Query| StreamlitApp
    StreamlitApp -->|2. POST /api/token| AuthService
    AuthService -->|3. Valid Token| StreamlitApp
    
    StreamlitApp -->|4. Authorized Query| FastAPI
    FastAPI -->|5. Verify Permissions| AuthService
    AuthService -->|6. OK| Orchestrator
    
    %% Caching Flow
    Orchestrator -->|7. Check Cache| Redis
    Redis -->|Hit| Orchestrator
    
    %% Main Execution Flow
    Redis -->|Miss| RAG_System
    RAG_System --> Orchestrator
    Orchestrator -->|8. Generate SQL| LLMFactory
    LLMFactory --> OpenAI & Gemini
    
    Orchestrator -->|9. Execute Query| ConnFactory
    ConnFactory -->|10. SQL Results| Orchestrator
    
    %% Error Handling
    Orchestrator -->|11. If SQL Fails| SelfCorrection
    SelfCorrection -->|Retry| LLMFactory
    
    %% Return Path
    Orchestrator -->|12. Store in Cache| Redis
    Orchestrator -->|13. Response| StreamlitApp
    
    %% Observability Paths
    FastAPI -.->|Metrics| Prom
    Prom -.-> Grafana